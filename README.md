# Connecting to DocumentDB across VPC

This project demonstrates a technique to connect to an Amazon DocumentDB cluster using VPC endpoints from across another VPC. It eliminates need for peering the VPCs, which is often viewed as difficult to manage and unsafe. VPC endpoints use an underlying networking technology called [AWS PrivateLink](https://docs.aws.amazon.com/vpc/latest/privatelink/what-is-privatelink.html), which establishes a highly scalable, private communication between service providers and consumers across VPC boundaries within a single AWS region. 

Beyond DocumentDB, the technique described here can easily be applied to other AWS managed services such as [Amazon RDS](https://aws.amazon.com/rds/), [Amazon MSK](https://aws.amazon.com/msk/) and several others. While some of these managed services offer VPC endpoints for control plane operations, they do not offer VPC endpoints for data plane operations. So, if you wish to access a database cluster from outside the cluster's VPC, you do not have many good options that does not involve peering the VPCs or connecting using a VPN gateway. 

> When using Amazon RDS and Amazon Aurora databases specifically, [Amazon RDS Proxy](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/rds-proxy-endpoints.html) now offers (announced March 2021) support for cross VPC endpoint access, and should be the preferred method of accessing RDS or Aurora databases from across another VPC. 

The basic idea of the technique shown here is to create a Network Load Balancer (NLB) in front of an AWS managed service, such as a DocumentDB cluster, and then setup the NLB as an *endpoint service*. Endpoint service is a special feature of NLB that allows a VPC endpoint to be created in another VPC. When a consumer application makes a connection request, that request is made to the VPC endpoint present inside the consumer's VPC. That request is securely routed via AWS PrivateLink to the endpoint service hosted by NLB in a different VPC. NLB sends the traffic to one or more *targets* attached to the NLB, which are nodes of DocumentDB cluster. NLB cannot use DNS hostnames to connect to its targets, they must be IP addresses (or instance ids, in case of EC2 instances). Therefore, we need a way to resolve the DocumentDB cluster's DNS hostname into an IP address, and to monitor the DNS for any changes that may occur during a failover event. This is why we use an AWS Lambda function to periodically monitor the DocumentDB cluster's endpoint hostname for any IP address changes. 

# Architecture

The following diagram shows the design implemented in this project: 
<br/><img src="diagram.png" width="821"/><br/>
[Figure 1: AWS architecture diagram showing DocumentDB access across VPC](diagram.png)

# Deployment 

To deploy this project in your own AWS environment, clone the github repo in a local working directory. Make sure to have a recent version of Terraform CLI installed. Next, create a new Terraform variable definitions file (such as `terraform.tfvars` for automatic loading). The variable definitions file must provide your environment-specific values for these variables (make sure to changes these values): 

```
aws_profile                 = "default" 
aws_region                  = "us-west-2"
aws_env                     = "test"
app_name                    = "DocumentDBCrossVPCAccess"
app_shortcode               = "ddcvpc"


docdb_vpc_id                = "vpc-0123456789abcdef0"
docdb_subnet_ids            = [ "subnet-56789abcdef012345", "subnet-89abcdef012345678" ] 
docdb_master_user           = "myadmin"

app_vpc_id                  = "vpc-abcdef123"
app_subnet_ids              = [ "subnet-86420eca", "subnet-ef012345" ] 
app_ssh_keypair_name        = "my_keypair"
app_ssh_cidr_blocks         = [ "0.0.0.0/0" ]
```

Finally, to deploy, run `terraform init` followed by `terraform apply`. Make sure to review the plan output before accepting to continue deployment. This will create all AWS resources defined in the Terraform module in this project. Once the deployment is complete, you will see a bunch of output values generated by Terraform CLI. Note these down. You may now SSH into the client app EC2 instance, and run the MongoDB client command displayed in the output to access the DocumentDB cluster. 

# TODOs

Following features have not been implemented in this project as yet: 

1. Support for DocumentDB's read-only endpoint (using same NLB but a different listener and target group)
2. Consumer side endpoint hostname that matches TLS certificate returned by VPC endpoint (using a private hosted zone and a corresponding custom TLS certificate)